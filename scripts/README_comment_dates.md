# Обновление дат комментариев при миграции из Kaiten в Bitrix24

Решение проблемы с неправильными датами комментариев при миграции.

## Проблема
API Bitrix24 не позволяет устанавливать произвольную дату комментария - все комментарии создаются с текущей датой и временем.

## Решение
Обновление дат комментариев через прямой SQL-запрос к базе данных Bitrix24 на VPS сервере.

## Компоненты решения

### 1. update_comment_dates.py
Python скрипт для обновления дат в MySQL БД Bitrix24 (выполняется на VPS).

**Использование:**
```bash
python3 update_comment_dates.py '{"comment_id": "2025-07-08 14:22:00"}'
```

### 2. deploy_simple.ps1
PowerShell скрипт для развертывания update_comment_dates.py на VPS.
Читает SSH настройки из переменных окружения (.env файл).

**Использование:**
```powershell
.\scripts\deploy_simple.ps1
```

### 3. Обновленная логика миграции
Модифицированный `CardMigrator.migrate_card_comments()` с автоматическим вызовом SSH скрипта для корректировки дат.

## Порядок использования

### Шаг 1: Настройка переменных окружения
Убедитесь, что в файле `.env` указаны SSH настройки:
```env
SSH_HOST="your.vps.server.ip"
SSH_USER="root"
SSH_KEY_PATH="/path/to/ssh/key"
SSH_KEY_PATH_PUTTY="/path/to/ssh/key.ppk"
VPS_SCRIPT_PATH="/root/update_comment_dates.py"
```

### Шаг 2: Развертывание скрипта на VPS
```powershell
# Из корневой папки проекта
.\scripts\deploy_simple.ps1
```

### Шаг 3: Установка зависимостей на VPS (если нужно)
```bash
ssh your-server
pip3 install pymysql
```

### Шаг 4: Обычная миграция карточек
При миграции карточек даты комментариев будут автоматически корректироваться:

```bash
# Миграция карточек из пространства
python scripts/card_migration.py --space-id 426722

# Миграция конкретной карточки  
python scripts/card_migration.py --space-id 426722 --card-id 49028902
```

## Технические детали

- **Таблица БД**: `b_forum_message`  
- **Поле даты**: `POST_DATE`
- **SSH настройки**: читаются из переменных окружения (.env файл)
- **БД**: `sitemanager` (MySQL)

## Безопасность
- SSH настройки хранятся в переменных окружения (.env файл)
- Используется конфигурационный файл `/root/.my.cnf` для подключения к MySQL
- SSH ключи для безопасного подключения
- Транзакционное обновление с откатом при ошибках
- .env файл исключен из git через .gitignore

## Примечания
- Решение работает только с VPS сервером с прямым доступом к БД Bitrix24
- Обновление дат происходит после создания всех комментариев карточки
- При отсутствии SSH настроек комментарии создаются с текущими датами
- SSH функция опциональна - миграция работает и без неё

## Скрипт развертывания
- `deploy_simple.ps1` - единственный безопасный скрипт развертывания
- Читает SSH настройки из переменных окружения (.env файл)
- Проверяет наличие всех необходимых настроек перед развертыванием 