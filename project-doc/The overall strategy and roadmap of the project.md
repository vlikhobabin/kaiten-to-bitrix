### **Общая стратегия и дорожная карта проекта**

Проект будет разделен на 4 основных этапа, которые можно разбить на 6-7 спринтов.

*   **Этап 1: Подготовка и Архитектура (Спринт 0-1)**
    *   **Цель:** Настроить окружение, финализировать маппинг, реализовать базовые модели данных и API-клиенты.
*   **Этап 2: Миграция базовых сущностей (Спринты 2-3)**
    *   **Цель:** Реализовать перенос ключевых, но относительно простых сущностей: пользователи, пространства (проекты), участники, доски и колонки (стадии задач).
*   **Этап 3: Миграция основных данных (Спринты 4-5)**
    *   **Цель:** Реализовать перенос самых объемных и сложных данных — карточек (задач) со всеми их атрибутами: чек-листами, файлами, тегами, подзадачами и пользовательскими полями.
*   **Этап 4: Стабилизация и развертывание (Спринт 6)**
    *   **Цель:** Провести комплексное тестирование, внедрить надежную обработку ошибок, логирование, подготовить документацию и провести пилотную миграцию.

---

### **Бэклог проекта по этапам и спринтам**

### **Этап 1: Подготовка и Архитектура (Спринт 0-1)**

#### **Спринт 0: Настройка и проектирование**

*   **Задача 1: Настройка среды разработки и проекта**
    *   **Описание:** Необходимо создать структуру проекта в Git, как предложено в файле `Kaiten to Bitrix24 Migration.md`. Настроить виртуальное окружение, установить базовые зависимости (`httpx`, `pydantic`, `python-dotenv`, `loguru`, `pytest`). Создать базовые конфигурационные файлы (`settings.py`, `.env.example`).
    *   **Критерии приемки:**
        1.  Репозиторий Git создан с предложенной структурой папок.
        2.  Файл `pyproject.toml` (или `requirements.txt`) содержит все необходимые библиотеки.
        3.  Инициализирован `pytest` и создан один пример теста, который успешно выполняется.
        4.  Настроен `loguru` для вывода логов в консоль и в файл.
        5.  Конфигурация считывается из `.env` файла.

*   **Задача 2: Финализация маппинга полей и создание моделей данных Pydantic**
    *   **Описание:** На основе таблицы соответствий создать Pydantic-модели для всех переносимых сущностей Kaiten и Bitrix24 в `models/`. Особое внимание уделить типам данных, опциональным полям. Создать файл `config/mappings.py` для хранения маппинга пользовательских полей и других настраиваемых соответствий.
    *   **Критерии приемки:**
        1.  Созданы Pydantic-модели для `User`, `Space`, `Board`, `Card` в `kaiten_models.py`.
        2.  Созданы Pydantic-модели для `User`, `Workgroup`, `Task` в `bitrix_models.py`.
        3.  Модели успешно проходят валидацию на примерах данных из API документации.
        4.  Файл `mappings.py` содержит структуру для сопоставления ID пользователей, статусов и т.д.

#### **Спринт 1: Реализация API-клиентов**

*   **Задача 3: Реализация клиента для Kaiten API (`kaiten_client.py`)**
    *   **Описание:** Разработать асинхронный клиент для Kaiten API с использованием `httpx`. Клиент должен инкапсулировать логику аутентификации (Bearer token) и предоставлять методы для получения основных сущностей: `get_users`, `get_spaces`, `get_boards`, `get_cards`.
    *   **Критерии приемки:**
        1.  Клиент успешно аутентифицируется в Kaiten API.
        2.  Реализован метод `get_spaces()`, который возвращает список Pydantic-моделей `KaitenSpace`.
        3.  Реализован метод `get_users()`, который возвращает список `KaitenUser`.
        4.  Код покрыт unit-тестами с использованием `pytest-mock` для мокирования HTTP-запросов.

*   **Задача 4: Реализация клиента для Bitrix24 API (`bitrix_client.py`)**
    *   **Описание:** Разработать асинхронный клиент для Bitrix24 REST API. Клиент должен работать через вебхуки, обрабатывать постраничную навигацию (ключи `next` и `total`). Реализовать базовые методы для создания и получения сущностей: `get_users`, `add_user`, `add_workgroup`, `get_workgroups`.
    *   **Критерии приемки:**
        1.  Клиент успешно отправляет запросы к вебхуку Bitrix24.
        2.  Реализован метод `get_users()`, который корректно обрабатывает пагинацию и возвращает список Pydantic-моделей `BitrixUser`.
        3.  Реализован метод `add_workgroup(group_data)`, который создает рабочую группу.
        4.  Код покрыт unit-тестами.

---

### **Этап 2: Миграция базовых сущностей (Спринты 2-3)**

#### **Спринт 2: Пользователи и Пространства**

*   **Задача 5: Разработка мигратора пользователей (Users)**
    *   **Описание:** Создать класс-трансформер и мигратор для пользователей. Логика должна включать: получение пользователей из Kaiten, сопоставление с существующими в Bitrix24 по email, создание недостающих. Необходимо сохранять маппинг `kaiten_user_id` -> `bitrix_user_id` для последующих шагов.
    *   **Критерии приемки:**
        1.  Трансформер корректно преобразует модель `KaitenUser` в `BitrixUser`.
        2.  Мигратор получает всех пользователей из Kaiten.
        3.  Мигратор создает в Bitrix24 только тех пользователей, которых нет (проверка по email).
        4.  В лог или отдельный файл сохраняется таблица соответствия ID.

** Новая редакция - объединение Задачи 6 и 7

### **Обновленный пункт бэклога (Спринт 2)**

*   **Задача 6 (Объединенная): Миграция иерархии пространств и досок Kaiten в Группы/Проекты Bitrix24**
    *   **Описание:**
        Задача объединяет и заменяет предыдущие задачи 6 и 7, реализуя новую, более корректную логику сопоставления сущностей: **1 Доска Kaiten = 1 Группа/Проект в Bitrix24**.

        Мигратор должен выполнить следующие шаги:
        1.  **Рекурсивно обойти всю иерархию пространств (`Spaces`) в Kaiten**, чтобы для каждой доски можно было построить полный путь. Этот путь будет использоваться для формирования уникального и понятного названия группы в Bitrix24.
        2.  **Для каждой доски (`Board`)**, найденной в Kaiten, **создать отдельную Группу/Проект (`Workgroup`)** в Bitrix24.
        3.  **Сформировать имя для новой Группы** по шаблону: `Путь/До/Родительского/Пространства/Название_Доски`.
            *   *Пример 1:* Доска `Задачи Финансовой Дирекции` в пространстве `Финансовая дирекция` мигрирует в группу с названием `Финансовая дирекция/Задачи Финансовой Дирекции`.
            *   *Пример 2:* Доска `Работы по проектному финансированию` в дочернем пространстве `Отдел бюджетирования и кредитования`, которое находится в `Финансовая дирекция`, мигрирует в группу `Финансовая дирекция/Отдел бюджетирования и кредитования/Работы по проектному финансированию`.
        4.  **Перенести участников.** Участники для создаваемой Группы Б24 берутся из того пространства Kaiten, в котором *непосредственно находится данная доска*. Перенос осуществляется с использованием ранее созданного маппинга ID пользователей (из Задачи 5).
        5.  **Мигрировать структуру доски.** После создания Группы, ее стадии задач (колонки канбана) должны быть настроены в соответствии с колонками (`Subcolumns`) исходной доски Kaiten.

    *   **Критерии приемки:**
        1.  Для **каждой** Доски (`Board`) в Kaiten создана отдельная Группа/Проект (`Workgroup`) в Bitrix24.
        2.  Наименование созданной Группы в Bitrix24 в точности соответствует шаблону `Путь/К/Пространству/Название_Доски`, отражая полную иерархию из Kaiten.
        3.  Участники пространства, в котором находится доска, корректно добавлены в качестве участников в соответствующую Группу Bitrix24, используя ранее созданный маппинг пользователей.
        НЕ ДЕЛАЕМ 4.  Стадии задач (колонки канбана) для каждой новой Группы созданы и их названия и порядок соответствуют колонкам (`Subcolumns`) на исходной доске Kaiten.
        5.  По итогам выполнения созданы и сохранены два ключевых словаря-соответствия для использования на последующих этапах:
            *   `kaiten_board_id -> bitrix_workgroup_id`
            *   НЕ ДЕЛАЕМ `kaiten_column_id -> bitrix_stage_id`
#### **Спринт 3: Задачи (каркас)**            
** конец новой редакции            

** Старая редакция - удалить!
*   **Задача 6: Разработка мигратора пространств и участников (Spaces -> Workgroups)**
    *   **Описание:** Создать мигратор для пространств. Он должен получать пространства из Kaiten, создавать для каждого соответствующий Группу в Bitrix24. Используя маппинг ID из предыдущей задачи, добавить в созданную группу соответствующих участников.
    *   **Критерии приемки:**
        1.  Для каждого `Space` из Kaiten создается `Workgroup` в Bitrix24.
        2.  Название и описание пространства переносятся корректно.
        3.  Все участники пространства Kaiten (`Space users`) добавляются в соответствующую `Workgroup` в Bitrix24.
        4.  Создается и сохраняется маппинг `kaiten_space_id` -> `bitrix_workgroup_id`.

#### **Спринт 3: Доски и Задачи (каркас)**

*   **Задача 7: Миграция структуры досок (Boards, Subcolumns)**
    *   **Описание:** Реализовать логику сопоставления досок и колонок. Поскольку доска в Bitrix24 — это представление задач в проекте, основной фокус здесь на миграции колонок (`Subcolumn`) в стадии задач (`Task stages`) внутри ранее созданных проектов.
    *   **Критерии приемки:**
        1.  Для каждого проекта (бывшего пространства) в Bitrix24 создаются стадии задач, имена которых соответствуют именам колонок на доске Kaiten.
        2.  Сохраняется маппинг `kaiten_column_id` -> `bitrix_stage_id`.
** конец старая редакции         

*   **Задача 8: Миграция карточек (Cards -> Tasks) - базовый перенос**
    *   **Описание:** Создать мигратор для карточек. На этом этапе реализовать перенос только основных полей: название, описание, ответственный, создатель, срок. Карточка должна создаваться в правильном проекте и на правильной стадии.
    **Мэпинг колонок-стадий**
    Мы отказались от переноса колонки Кайтен в стадии Битрикс. Поэтому при переносе карточке необходимо использовать следующий, программно заданный алгоритм мэпинга:
    1. Карточки из колонок `type: 1` - начальная, переносятся в `Новые` - стандартная существующая стадия Bitrix24,
    2. Карточки из из колонок `type: 3` - финальная, НЕ ПЕРЕНОСЯТСЯ (т.к. это фактически завершенные задачи, которые, со временем, в Кайтен уйдут в архив Кайтен)
    3. Карточки из всех остальных колонок мигрируют в колонку `Выполняются`

    Все указанные колонки-стадии Bitrix24 (`Новые`, `Выполняются`, а также `Сделаны`) - стандартные существующие стадии Bitrix24, которые можно найти по имени.

    Swim Lanes (приоритеты) - ни как не анализируем и не переносим.
    Subcolumns (подколонки) - правила мэпинга такие же как и колонок (columns), если нет свойства `type`, тогда `type` определяем по родительской колонке 

    Из Кайтен НЕ ПЕРЕНОСИМ архивные и выполненные `type: 3` карточки 

    *   **Критерии приемки:**
        1.  Задачи создаются в Bitrix24 для каждой карточки из Kaiten.
        2.  Задача помещается в проект, соответствующий пространству карточки.
        3.  Задача устанавливается в стадию, соответствующую колонке карточки.
        4.  Поля `title`, `description`, `responsible_id`, `created_by`, `deadline` перенесены корректно.
        5.  Создан и сохранен маппинг `kaiten_card_id` -> `bitrix_task_id`.

---

### **Этап 3: Миграция основных данных (Спринты 4-5)**

#### **Спринт 4: Атрибуты задач**

*   **Задача 9: Миграция чек-листов (Checklists)**
    *   **Описание:** Расширить мигратор задач. Для каждой карточки получать ее чек-листы и элементы. Используя `task.checklistitem.add`, создавать аналогичные чек-листы в задачах Bitrix24.
    *   **Критерии приемки:**
        1.  Все чек-листы и их элементы из карточки Kaiten переносятся в соответствующую задачу Bitrix24.
        2.  Сохраняется статус выполнения элемента чек-листа (выполнен/не выполнен).

*   **Задача 10: Миграция вложений (Card Files)**
    *   **Описание:** Реализовать перенос файлов. Логика должна включать: скачивание файла из Kaiten, загрузку его на Диск Bitrix24 (`disk.storage.uploadfile`), и прикрепление полученного файла к соответствующей задаче.
    *   **Критерии приемки:**
        1.  Все файлы из карточки Kaiten успешно скачиваются.
        2.  Файлы загружаются в папку на Диске Bitrix24 (например, в папку проекта).
        3.  Загруженные файлы прикреплены к нужной задаче в Bitrix24.

*   **Задача 11: Миграция дочерних карточек (Card Children -> Subtasks)**
    *   **Описание:** Доработать мигратор задач для поддержки иерархии. При создании задачи проверять, есть ли у исходной карточки родитель. Если да, при создании задачи в Bitrix24 указывать `PARENT_ID`, используя ранее сохраненный маппинг `kaiten_card_id` -> `bitrix_task_id`.
    *   **Критерии приемки:**
        1.  Иерархия "задача-подзадача" из Kaiten полностью воспроизведена в Bitrix24.
        2.  Процесс корректно работает для нескольких уровней вложенности.

#### **Спринт 5: Пользовательские данные и связи**

*   **Задача 12: Миграция пользовательских полей (Custom Properties, Card Types)**
    *   **Описание:** Реализовать перенос пользовательских полей. Предполагается, что администратор заранее создал в Bitrix24 UF-поля. Мигратор должен использовать `config/mappings.py` для сопоставления полей Kaiten и Bitrix24 и переносить их значения. Тип карточки (`Card Type`) переносится в отдельное пользовательское поле типа "список".
    *   **Критерии приемки:**
        1.  Значения из пользовательских полей карточки Kaiten переносятся в соответствующие `UF_*` поля задачи Bitrix24.
        2.  Тип карточки корректно установлен в целевом поле.

*   **Задача 13: Миграция тегов (Tags)**
    *   **Описание:** Добавить в мигратор задач логику переноса тегов. Получать теги из карточки и передавать их в поле `TAGS` при создании/обновлении задачи в Bitrix24.
    *   **Критерии приемки:**
        1.  Все теги с карточки Kaiten присутствуют в соответствующей задаче Bitrix24.

*   **Задача 14: Реализация переноса дорожек (Lanes)**
    *   **Описание:** Реализовать логику эмуляции дорожек. Выбрать стратегию (например, через пользовательское поле "Дорожка"). Добавить в мигратор логику, которая будет считывать дорожку карточки и заполнять соответствующее пользовательское поле в задаче Bitrix24.
    *   **Критерии приемки:**
        1.  В Bitrix24 создано пользовательское поле для задач (например, `UF_LANE_NAME`).
        2.  Для каждой перенесенной задачи это поле заполнено названием дорожки из Kaiten.

---

### **Этап 4: Стабилизация и развертывание (Спринт 6)**

*   **Задача 15: Комплексное E2E тестирование**
    *   **Описание:** Написать скрипт, который запускает полный цикл миграции на ограниченном наборе тестовых данных (1-2 пространства со всеми типами сущностей). Скрипт должен автоматически проверять, что все данные перенеслись корректно.
    *   **Критерии приемки:**
        1.  E2E тест успешно проходит на тестовом наборе данных.
        2.  Тест проверяет корректность переноса всех сущностей, включая файлы, подзадачи и пользовательские поля.

*   **Задача 16: Внедрение обработки ошибок и механизма перезапуска**
    *   **Описание:** Доработать код для устойчивости к сбоям. Внедрить обработку лимитов API (retry-механизм с экспоненциальной задержкой). Обеспечить возможность "продолжить" миграцию с места остановки, пропуская уже перенесенные сущности.
    *   **Критерии приемки:**
        1.  Приложение не падает при получении ошибок API (например, 429 Too Many Requests), а ждет и повторяет запрос.
        2.  При повторном запуске скрипт не создает дубликаты пользователей, проектов и задач.

*   **Задача 17: Финализация логирования и создание отчетов**
    *   **Описание:** Улучшить логирование. В конце работы скрипт должен выводить в консоль и сохранять в файл итоговый отчет: сколько сущностей каждого типа было обработано, сколько перенесено успешно, сколько завершилось с ошибкой.
    *   **Критерии приемки:**
        1.  Логи содержат детальную информацию о ходе миграции и ошибках.
        2.  По окончании работы генерируется читаемый отчет.

*   **Задача 18: Подготовка документации для запуска**
    *   **Описание:** Создать файл `README.md` с подробной инструкцией: как установить зависимости, как настроить конфигурацию (токены, вебхук, маппинги), как запустить миграцию.
    *   **Критерии приемки:**
        1.  `README.md` содержит все необходимые инструкции.
        2.  Другой разработчик может, следуя инструкции, успешно запустить скрипт.